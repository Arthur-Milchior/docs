

<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="X-UA-Compatible" content="IE=edge">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@JinaAI_">
<meta name="twitter:creator" content="@JinaAI_">
<meta name="description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:title" content="Jina Documentation">
<meta property="og:description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:url" content="https://opensource.jina.ai">
<meta property="og:image" content="../../_static/banner.png">
<meta property="og:type" content="website">
<link rel="icon" href="../../_static/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>Using Flow API to Compose Your Jina Workflow &mdash; Jina 0.8.6 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/main.css" type="text/css" />

<!--  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">-->


  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Understand Jina Recursive Document Representation" href="../traversal/index.html" />
    <link rel="prev" title="Jina 101: First Thing to Learn About Jina" href="../101/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/jina-prod-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8.6
              </div>
            
          


          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/via-pip.html">Install Jina via <code class="docutils literal notranslate"><span class="pre">pip</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/via-docker.html">Install Jina via Docker Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/on-rasp-linux.html">Install Jina on Raspberry Pi and other Linux Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/on-x.html">Can I Run Jina On ‚Ä¶.?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/on-wsl.html">Install Jina on Windows Subsystem for Linux (WSL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/upgrade.html">Upgrade Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/autocomplete.html">Autocomplete commands on Bash, Zsh and Fish</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../helloworld/index.html">Jina ‚ÄúHello, World!‚Äù üëãüåç</a></li>
<li class="toctree-l1"><a class="reference internal" href="../101/index.html">Jina 101: First Thing to Learn About Jina</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using Flow API to Compose Your Jina Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="#common-design-patterns">Common Design Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../traversal/index.html">Understand Jina Recursive Document Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../io/index.html">Input and Output Functions in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hub/index.html">Using Jina Pod with Docker Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Using Jina Pod Remotely</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging/index.html">Logging configuration in jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dashboard/index.html">Using Dashboard to Monitor Logs and View Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/exit.html">Gracefully Exit Jina</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Jina Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/jina.html">Jina Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yaml/yaml.html">Jina YAML Syntax Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simple_exec.html">Built-in Simple Executors and Reserved <code class="docutils literal notranslate"><span class="pre">uses</span></code> in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proto/index.html">Jina Protobuf Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../restapi/index.html">Jina REST API Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envs.html">OS Environment Variables Used in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_schema.html">Jina API Schema for 3rd-Party Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prevent_duplicate_indexing/index.html">Prevent Indexing Duplicates</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending Jina</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extend/mwu.html">A Minimum Working Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extend/executor.html">Guideline When Adding New Executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extend/driver.html">Guideline When Adding New Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hub/publish-your-pod-image.html">Publish Your Pod Image to Jina Hub</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing to Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html#join-us-on-slack">Join Us on Slack!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jep/index.html">Jina Enhancement Proposals (JEP)</a></li>
</ul>
<p class="caption"><span class="caption-text">Release Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release Cycle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Change Logs</a></li>
</ul>
<p class="caption"><span class="caption-text">Debugging and FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/user.html">FAQ for End-Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/dev.html">FAQ for Developers</a></li>
</ul>
<p class="caption"><span class="caption-text">Indices and Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../all_exec.html">List of 100 Executors in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../all_driver.html">List of 60 Drivers in Jina</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Jina</a>
        
      </nav>

   
      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation" class="nav-bar-header">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Using Flow API to Compose Your Jina Workflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  
<div role="search" class="nav-bar-search">
  <form id="rtd-search-form" class="wy-form doc-searchbox" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs (Press / to focus)" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

</div>
<hr/>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-flow-api-to-compose-your-jina-workflow">
<h1>Using Flow API to Compose Your Jina Workflow<a class="headerlink" href="#using-flow-api-to-compose-your-jina-workflow" title="Permalink to this headline">¬∂</a></h1>
<p>In search systems, tasks such as indexing often involve multiple steps: preprocessing, encoding, storing, etc. In Jina‚Äôs architecture, each step is implemented by an Executor and wrapped by a Pod. This microservice design makes the whole pipeline flexible and scalable. Accomplishing a task is then orchestrating all these Pods to work together, either sequentially or in parallel; locally or remotely.</p>
<p>The Flow API is a context manager for Pods. Each <code class="docutils literal notranslate"><span class="pre">Flow</span></code> object corresponds to a real-world task. It helps the user to manage the states and contexts of all Pods required in that task. The Flow API translates a workflow defined in Python code, YAML file, or interactive graph to a runtime backed by multi-thread/process, Kubernetes, Docker Swarm, etc. Users don‚Äôt need to worry about where the Pod is running or how the Pods are connected.</p>
<p><img alt="Flow is a context manager" src="../../_images/flow-api-doc.png" /></p>
<!-- START doctoc generated TOC please keep comment here to allow auto update --><!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE --><ul class="simple">
<li><p><a class="reference external" href="#use-flow-api-in-python">Use Flow API in Python</a></p></li>
<li><p><a class="reference external" href="#use-flow-api-in-yaml">Use Flow API in YAML</a></p></li>
<li><p><a class="reference external" href="#design-a-flow-with-dashboard">Design a Flow with Dashboard</a></p></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update --><div class="section" id="use-flow-api-in-python">
<h2>Use Flow API in Python<a class="headerlink" href="#use-flow-api-in-python" title="Permalink to this headline">¬∂</a></h2>
<div class="section" id="create-a-flow">
<h3>Create a Flow<a class="headerlink" href="#create-a-flow" title="Permalink to this headline">¬∂</a></h3>
<p>To create a new Flow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jina.flow</span> <span class="kn">import</span> <span class="n">Flow</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Flow()</span></code> accepts some arguments, see <code class="docutils literal notranslate"><span class="pre">jina</span> <span class="pre">flow</span> <span class="pre">--help</span></code> or <a class="reference external" href="https://docs.jina.ai">our documentation</a> for details. For example, <code class="docutils literal notranslate"><span class="pre">Flow(log_server=True)</span></code> will enable sending logs to the <a class="reference external" href="https://github.com/jina-ai/dashboard">dashboard</a>.</p>
<p>When the arguments given to <code class="docutils literal notranslate"><span class="pre">Flow()</span></code> cannot be parsed, they are propagated to all the Flow‚Äôs <code class="docutils literal notranslate"><span class="pre">Pods</span></code> for parsing (if they are accepted, see <code class="docutils literal notranslate"><span class="pre">jina</span> <span class="pre">pod</span> <span class="pre">--help</span></code> for the list of arguments). For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>will set the <code class="docutils literal notranslate"><span class="pre">read_only</span></code> attribute of all Pods in <code class="docutils literal notranslate"><span class="pre">f</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</div>
<div class="section" id="add-pod-into-the-flow">
<h3>Add Pod into the Flow<a class="headerlink" href="#add-pod-into-the-flow" title="Permalink to this headline">¬∂</a></h3>
<p>To add a Pod to the Flow, simply call <code class="docutils literal notranslate"><span class="pre">.add()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="s1">&#39;mypod1.yml&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="s1">&#39;mypod2.yml&#39;</span><span class="p">,</span> <span class="n">timeout_ready</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="s1">&#39;mypod3.yml&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>This will create a sequential workflow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="n">gateway</span> <span class="o">-&gt;</span> <span class="n">p1</span> <span class="o">-&gt;</span> <span class="n">p2</span> <span class="o">-&gt;</span> <span class="n">p3</span> <span class="o">-&gt;</span> <span class="n">gateway</span>
</pre></div>
</div>
<p>The input of each Pod is the output of the last Pod in sequential order. The gateway is the entrypoint of the whole Jina network. The <code class="docutils literal notranslate"><span class="pre">gateway</span></code> Pod is automatically added to every <code class="docutils literal notranslate"><span class="pre">Flow</span></code>, of which the output is the first Pod and the input is the last Pod defined in the Flow.</p>
<p>All accepted arguments follow the command line interface of <code class="docutils literal notranslate"><span class="pre">Pod</span></code>, which can be found in <code class="docutils literal notranslate"><span class="pre">jina</span> <span class="pre">pod</span> <span class="pre">--help</span></code>. Just remember to replace the dash <code class="docutils literal notranslate"><span class="pre">-</span></code> to underscore <code class="docutils literal notranslate"><span class="pre">_</span></code> in the name of the argument when referring to it in Python.</p>
<p>Besides the file path, in Flow API <code class="docutils literal notranslate"><span class="pre">uses</span></code> can accept other types:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Type</th>
<th>Example</th>
<th>Remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>YAML file path</td>
<td><code>crafter/my.yml</code></td>
<td></td>
</tr>
<tr>
<td>Inline YAML</td>
<td><code>'!DataURICrafter\nwith: {mimetype: png}'</code></td>
<td>don't forget <code>!</code> in the beginning</td>
</tr>
<tr>
<td>The name of an executor <a href="../all_exec.html">listed here</a></td>
<td><code>TransformerTorchEncoder</code></td>
<td>only the executors that have full default values can be directly used</td>
</tr>
<tr>
<td>Built-in simple executors <a href="../simple_exec.html">listed here</a></td>
<td><code>_clear</code></td>
<td>Always starts with <code>_</code></td>
</tr>
</tbody>
</table>
<h4>Add a Containerized Pod into the Flow</h4><p>To run a Pod in a Docker container, simply specify the <code class="docutils literal notranslate"><span class="pre">image</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;jinaai/hub.executors.encoders.bidaf:latest&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This will run <code class="docutils literal notranslate"><span class="pre">p2</span></code> in a Docker container equipped with the image <code class="docutils literal notranslate"><span class="pre">jinaai/hub.executors.encoders.bidaf:latest</span></code>. More information on using containerized Pod can be found in <a class="reference external" href="https://docs.jina.ai">our documentation</a>.</p>
<div class="section" id="add-a-remote-pod-into-the-flow">
<h4>Add a Remote Pod into the Flow<a class="headerlink" href="#add-a-remote-pod-into-the-flow" title="Permalink to this headline">¬∂</a></h4>
<p>To run a Pod remotely, simply specify the <code class="docutils literal notranslate"><span class="pre">host</span></code> and <code class="docutils literal notranslate"><span class="pre">port_expose</span></code> arguments. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.0.100&#39;</span><span class="p">,</span> <span class="n">port_expose</span><span class="o">=</span><span class="mi">53100</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This will start <code class="docutils literal notranslate"><span class="pre">p2</span></code> remotely on <code class="docutils literal notranslate"><span class="pre">192.168.0.100</span></code>, whereas <code class="docutils literal notranslate"><span class="pre">p1</span></code> and <code class="docutils literal notranslate"><span class="pre">p3</span></code> run locally.</p>
<p>To use remote Pods, you need to start a <code class="docutils literal notranslate"><span class="pre">gateway</span></code> on <code class="docutils literal notranslate"><span class="pre">192.168.0.100</span></code> in advance. More information on using remote Pods can be found in <a class="reference external" href="https://docs.jina.ai">our documentation</a>.</p>
</div>
<div class="section" id="add-a-remote-containerized-pod-into-the-flow">
<h4>Add a Remote Containerized Pod into the Flow<a class="headerlink" href="#add-a-remote-containerized-pod-into-the-flow" title="Permalink to this headline">¬∂</a></h4>
<p>A very useful pattern is to combine the above two features together:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.0.100&#39;</span><span class="p">,</span> <span class="n">port_expose</span><span class="o">=</span><span class="mi">53100</span><span class="p">,</span>
                <span class="n">image</span><span class="o">=</span><span class="s1">&#39;jinaai/hub.executors.encoders.bidaf:latest&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This will start <code class="docutils literal notranslate"><span class="pre">p2</span></code> remotely on <code class="docutils literal notranslate"><span class="pre">192.168.0.100</span></code> running a Docker container equipped with the image <code class="docutils literal notranslate"><span class="pre">jinaai/hub.executors.encoders.bidaf:latest</span></code>. Of course Docker is required on <code class="docutils literal notranslate"><span class="pre">192.168.0.100</span></code>. More information on using remote Pods can be found in <a class="reference external" href="https://docs.jina.ai">our documentation</a>.</p>
</div>
</div>
<div class="section" id="parallelize-the-steps">
<h3>Parallelize the Steps<a class="headerlink" href="#parallelize-the-steps" title="Permalink to this headline">¬∂</a></h3>
<p>By default, if you keep adding <code class="docutils literal notranslate"><span class="pre">.add()</span></code> to a <code class="docutils literal notranslate"><span class="pre">Flow</span></code>, it will create a long chain of sequential workflow. You can parallelize some of the steps by using <code class="docutils literal notranslate"><span class="pre">needs</span></code> argument. For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span> <span class="n">needs</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This creates a workflow, where <code class="docutils literal notranslate"><span class="pre">p2</span></code> and <code class="docutils literal notranslate"><span class="pre">p3</span></code> work in parallel with the output of <code class="docutils literal notranslate"><span class="pre">p1</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gateway</span> <span class="o">-&gt;</span> <span class="n">p1</span> <span class="o">-&gt;</span> <span class="n">p2</span>
            <span class="o">|</span>
              <span class="o">-&gt;</span> <span class="n">p3</span> <span class="o">-&gt;</span> <span class="n">gateway</span> 
</pre></div>
</div>
</div>
<div class="section" id="waiting-for-parallel-steps-to-finish">
<h3>Waiting for Parallel Steps to Finish<a class="headerlink" href="#waiting-for-parallel-steps-to-finish" title="Permalink to this headline">¬∂</a></h3>
<p>In the prior example, the message is returned to the gateway regardless of the status of <code class="docutils literal notranslate"><span class="pre">p2</span></code>. To wait for multiple parallel steps to finish before continuing, you can do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span> <span class="n">needs</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="s1">&#39;p3&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>which gives</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gateway</span> <span class="o">-&gt;</span> <span class="n">p1</span> <span class="o">-&gt;</span> <span class="n">p2</span> <span class="o">-&gt;</span>
            <span class="o">|</span>          <span class="o">|</span> <span class="o">-&gt;</span> <span class="n">wait</span> <span class="n">until</span> <span class="n">both</span> <span class="n">done</span> <span class="o">-&gt;</span> <span class="n">gateway</span>
              <span class="o">-&gt;</span> <span class="n">p3</span> <span class="o">-&gt;</span> 
</pre></div>
</div>
</div>
<div class="section" id="run-a-flow">
<h3>Run a Flow<a class="headerlink" href="#run-a-flow" title="Permalink to this headline">¬∂</a></h3>
<p>To run a Flow, simply use the <code class="docutils literal notranslate"><span class="pre">with</span></code> keyword:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>

<span class="k">with</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># the flow is now running</span>
</pre></div>
</div>
<p>Though you can manually call the <code class="docutils literal notranslate"><span class="pre">start()</span></code> method to run the flow, you also need to call the corresponding <code class="docutils literal notranslate"><span class="pre">close()</span></code> method to release the resource. Using <code class="docutils literal notranslate"><span class="pre">with</span></code> saves you the trouble, as the resource is automatically released when running out of the scope.</p>
<div class="section" id="test-connectivity-with-dry-run">
<h4>Test Connectivity with Dry Run<a class="headerlink" href="#test-connectivity-with-dry-run" title="Permalink to this headline">¬∂</a></h4>
<p>You can test the whole workflow with <code class="docutils literal notranslate"><span class="pre">dry_run()</span></code>. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">with</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">dry_run</span><span class="p">()</span>
</pre></div>
</div>
<p>This will send a <code class="docutils literal notranslate"><span class="pre">ControRequest</span></code> to all pods following the topology you defined. You can use it to test the connectivity of all pods.</p>
</div>
</div>
<div class="section" id="iterate-over-pods-in-the-flow">
<h3>Iterate over Pods in the Flow<a class="headerlink" href="#iterate-over-pods-in-the-flow" title="Permalink to this headline">¬∂</a></h3>
<p>You can iterate the Pods in a Flow like you would a list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
           <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">build</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> in: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">head_args</span><span class="o">.</span><span class="n">socket_in</span><span class="p">)</span><span class="si">}</span><span class="s1"> out: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">head_args</span><span class="o">.</span><span class="n">socket_out</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note <code class="docutils literal notranslate"><span class="pre">f.build()</span></code> will build the underlying network context but not run the Pods. It is very useful for debugging.</p>
</div>
<div class="section" id="feed-data-to-the-flow">
<h3>Feed Data to the Flow<a class="headerlink" href="#feed-data-to-the-flow" title="Permalink to this headline">¬∂</a></h3>
<p>You can use <code class="docutils literal notranslate"><span class="pre">.index()</span></code>, <code class="docutils literal notranslate"><span class="pre">.search()</span></code> to feed index data and search query to a Flow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">input_fn</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">input_fn</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">output_fn</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">input_fn</span></code> is an <code class="docutils literal notranslate"><span class="pre">Iterator[bytes]</span></code>, each of which corresponds to the representation of a Document with bytes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output_fn</span></code> is the callback function after each request, and takes a <code class="docutils literal notranslate"><span class="pre">Request</span></code> protobuf as its only input.</p></li>
</ul>
<p>A simple <code class="docutils literal notranslate"><span class="pre">input_fn</span></code> is defined as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">input_fn</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">yield</span> <span class="sa">b</span><span class="s1">&#39;s&#39;</span>

<span class="c1"># or ...</span>
<span class="n">input_fn</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;s&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<blockquote>
<div><p>Please note that the current Flow API does not support using <code class="docutils literal notranslate"><span class="pre">index()</span></code> and <code class="docutils literal notranslate"><span class="pre">search()</span></code> together in the same <code class="docutils literal notranslate"><span class="pre">with</span></code> scope. This is because the workflow of <code class="docutils literal notranslate"><span class="pre">index()</span></code> and <code class="docutils literal notranslate"><span class="pre">search()</span></code> are usually different and you cannot use one workflow for both tasks.</p>
</div></blockquote>
<div class="section" id="feed-data-to-the-flow-from-other-clients">
<h4>Feed Data to the Flow from Other Clients<a class="headerlink" href="#feed-data-to-the-flow-from-other-clients" title="Permalink to this headline">¬∂</a></h4>
<p>If you don‚Äôt use Python as a client, or your client and Flow are in different instances, you can keep a Flow running and use a client in another language to connect to it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">with</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">block</span><span class="p">()</span>
</pre></div>
</div>
<p>Please check out our <a class="reference external" href="https://github.com/jina-ai/examples/tree/master/helloworld-in-cs">hello world in client-server architecture</a> for a complete example.</p>
<p><strong>WARNING</strong>: don‚Äôt use a while loop to do the waiting, it is extremely inefficient:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># &lt;- dont do that</span>
        <span class="k">pass</span> <span class="c1"># &lt;- dont do that</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="use-flow-api-in-yaml">
<h2>Use Flow API in YAML<a class="headerlink" href="#use-flow-api-in-yaml" title="Permalink to this headline">¬∂</a></h2>
<p>You can also write a Flow in YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!Flow</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">logserver</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">pods</span><span class="p">:</span>
  <span class="nt">chunk_seg</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">craft/index-craft.yml</span>
    <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$REPLICAS</span>
    <span class="nt">read_only</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">doc_idx</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">index/doc.yml</span>
  <span class="nt">tf_encode</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">encode/encode.yml</span>
    <span class="nt">needs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chunk_seg</span>
    <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$REPLICAS</span>
    <span class="nt">read_only</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">chunk_idx</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">index/chunk.yml</span>
    <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$SHARDS</span>
    <span class="nt">separated_workspace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">join_all</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">_pass</span>
    <span class="nt">needs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">doc_idx</span><span class="p p-Indicator">,</span> <span class="nv">chunk_idx</span><span class="p p-Indicator">]</span>
    <span class="nt">read_only</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>You can use enviroment variables with <code class="docutils literal notranslate"><span class="pre">$</span></code> in YAML. More information on the Flow YAML Schema can be found in <a class="reference external" href="https://docs.jina.ai">our documentation</a>.</p>
<div class="section" id="load-a-flow-from-yaml">
<h3>Load a Flow from YAML<a class="headerlink" href="#load-a-flow-from-yaml" title="Permalink to this headline">¬∂</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jina.flow</span> <span class="kn">import</span> <span class="n">Flow</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">Flow</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s1">&#39;myflow.yml&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="start-a-flow-directly-from-the-cli">
<h3>Start a Flow Directly from the CLI<a class="headerlink" href="#start-a-flow-directly-from-the-cli" title="Permalink to this headline">¬∂</a></h3>
<p>The following command will start a Flow from the console and hold it for a client to connect.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jina flow --yaml-path myflow.yml
</pre></div>
</div>
</div>
</div>
<div class="section" id="design-a-flow-with-dashboard">
<h2>Design a Flow with Dashboard<a class="headerlink" href="#design-a-flow-with-dashboard" title="Permalink to this headline">¬∂</a></h2>
<p>With Jina Dashboard, you can interactively drag and drop Pods, set their attribute and export to a Flow YAML file.</p>
<p><img alt="Dashboard" src="../../_images/flow-demo1.gif" /></p>
<p>More information on the dashboard can be found <a class="reference external" href="https://github.com/jina-ai/dashboard">here</a>.</p>
</div>
</div>
<div class="section" id="common-design-patterns">
<h1>Common Design Patterns<a class="headerlink" href="#common-design-patterns" title="Permalink to this headline">¬∂</a></h1>
<p>Jina is a really flexible AI-powered neural search framework and is designed to enable any pattern that can be framed as a neural search problem. However, there are basic common patterns that show up when developing search solutions with Jina:</p>
<div class="section" id="compoundindexer-vector-kv-indexers">
<h2>CompoundIndexer (Vector + KV Indexers)<a class="headerlink" href="#compoundindexer-vector-kv-indexers" title="Permalink to this headline">¬∂</a></h2>
<p>For neural search applications, it helps to use a <code class="docutils literal notranslate"><span class="pre">CompoundIndexer</span></code> in the same Pod for both the index and query Flows. The following YAML file shows an example of this pattern:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!CompoundIndexer</span>
<span class="nt">components</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="kt">!NumpyIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vectors.gz</span>
      <span class="nt">metric</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cosine</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecIndexer</span>
  <span class="p p-Indicator">-</span> <span class="kt">!BinaryPbIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">values.gz</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kvIndexer</span>  <span class="c1"># a customized name</span>
<span class="nt">metas</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">complete indexer</span>
</pre></div>
</div>
<p>The above YAML creates a Flow that:</p>
<ul class="simple">
<li><p>Acts as a single indexer</p></li>
<li><p>Lets you seamlessly query the index with the embedding vector from any upstream encoder</p></li>
<li><p>Returns the binary information in the key-value index in the Pod‚Äôs response message.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">VectorIndexer</span></code>:</p>
<ul class="simple">
<li><p>Retrieves the most relevant Documents by finding similarities in the embedding space</p></li>
<li><p>Uses the key-value index to extract meaningful data and fields from those Documents</p></li>
</ul>
</div>
<div class="section" id="text-document-segmentation">
<h2>Text Document Segmentation<a class="headerlink" href="#text-document-segmentation" title="Permalink to this headline">¬∂</a></h2>
<p>A common search pattern is storing long text documents in an index to retrieve them later using short sentences. A single embedding vector per long text document is not the proper way to do this: It makes it hard to extract a single semantically-meaningful vector from a long document. Jina solves this by introducing <a class="reference external" href="https://github.com/jina-ai/jina/tree/master/docs/chapters/101#document--chunk">Chunks</a>. The common scenario is to have a <code class="docutils literal notranslate"><span class="pre">crafter</span></code> segmenting the document into smaller parts (typically short sentences) followed by an NLP-based encoder.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!Sentencizer</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">min_sent_len</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="nt">max_sent_len</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">64</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!TransformerTorchEncoder</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">pooling_strategy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">auto</span>
  <span class="nt">pretrained_model_name_or_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">distilbert-base-cased</span>
  <span class="nt">max_length</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">96</span>
</pre></div>
</div>
<p>This way a single document contains <code class="docutils literal notranslate"><span class="pre">N</span></code> different Chunks that are later independently encoded by a downstream encoder. This lets Jina query the index using a short sentence as input, where similarity search can be applied to find the most common Chunks. This way the same Document can be retrieved based on searching different parts of it.</p>
<p>For instance, a text document containing 3 sentences can be decomposed into 3 Chunks:</p>
<p><code class="docutils literal notranslate"><span class="pre">Someone</span> <span class="pre">is</span> <span class="pre">waiting</span> <span class="pre">at</span> <span class="pre">the</span> <span class="pre">bus</span> <span class="pre">stop.</span> <span class="pre">John</span> <span class="pre">looks</span> <span class="pre">surprised,</span> <span class="pre">his</span> <span class="pre">face</span> <span class="pre">seems</span> <span class="pre">familiar</span></code> -&gt;
[<code class="docutils literal notranslate"><span class="pre">Someone</span> <span class="pre">is</span> <span class="pre">waiting</span> <span class="pre">at</span> <span class="pre">the</span> <span class="pre">bus</span> <span class="pre">stop</span></code>, <code class="docutils literal notranslate"><span class="pre">John</span> <span class="pre">looks</span> <span class="pre">surprised</span></code>, <code class="docutils literal notranslate"><span class="pre">his</span> <span class="pre">face</span> <span class="pre">seems</span> <span class="pre">familiar</span></code>]</p>
<p>This lets us retrieve the Document from different <code class="docutils literal notranslate"><span class="pre">input</span></code> sentences that match any of these 3 parts. For instance, these 3 different inputs could lead to the extraction of the same document by targeting 3 different Chunks:</p>
<ul class="simple">
<li><p>A standing guy -&gt; Someone is waiting at the bus stop.</p></li>
<li><p>He is amazed` -&gt; John looks surprised.</p></li>
<li><p>a similar look -&gt; his face seems familiar.</p></li>
</ul>
</div>
<div class="section" id="indexers-at-different-depth-levels">
<h2>Indexers at Different Depth Levels<a class="headerlink" href="#indexers-at-different-depth-levels" title="Permalink to this headline">¬∂</a></h2>
<p>In a configuration like the one for <em>Text Document Segmentation</em>, we need different levels of indexing. The system needs to keep the data related to the Chunks as well as the information of the original documents. This way:</p>
<ol class="simple">
<li><p>The actual search is performed at the Chunk level following the <code class="docutils literal notranslate"><span class="pre">CompoundIndexer</span></code> pattern.</p></li>
<li><p>Then the Document indexer works as a final step to extract the actual Documents expected by the user.</p></li>
</ol>
<p>To implement this, two common structures appear in <code class="docutils literal notranslate"><span class="pre">index</span></code> and <code class="docutils literal notranslate"><span class="pre">query</span></code>. In an <code class="docutils literal notranslate"><span class="pre">index</span></code> flow, these two indexers work in parallel:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">chunk</span> <span class="pre">indexer</span></code> gets messages from an <code class="docutils literal notranslate"><span class="pre">encoder</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">doc</span> <span class="pre">indexer</span></code> can get the documents even from the <code class="docutils literal notranslate"><span class="pre">gateway</span></code>.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!Flow</span>
<span class="nt">pods</span><span class="p">:</span>
  <span class="nt">encoder</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BaseEncoder</span>
  <span class="nt">chunk_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CompoundIndexer</span>
  <span class="nt">doc_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BinaryPbIndexer</span>
    <span class="nt">needs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gateway</span>
  <span class="nt">join_all</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">_pass</span>
    <span class="nt">needs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">doc_indexer</span><span class="p p-Indicator">,</span> <span class="nv">chunk_indexer</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>However, at query time the Document and Chunk indexers work sequentially. Normally the Document would get messages from the Chunk indexer with a <code class="docutils literal notranslate"><span class="pre">Chunk2DocRanker</span></code> Pod in the middle of the Flow. The <code class="docutils literal notranslate"><span class="pre">ranker</span></code> would rank the Chunks by relevance and reduce the results to the parent IDs, enabling the <code class="docutils literal notranslate"><span class="pre">doc</span> <span class="pre">indexer</span></code> to extract the original Document‚Äôs binary information.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!Flow</span>
  <span class="nt">encoder</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BaseEncoder</span>
  <span class="nt">chunk_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CompoundIndexer</span>
  <span class="nt">ranker</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Chunk2DocRanker</span>
  <span class="nt">doc_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BinaryPbIndexer</span>
</pre></div>
</div>
</div>
<div class="section" id="switch-vector-indexer-at-query-time">
<h2>Switch Vector Indexer at Query Time<a class="headerlink" href="#switch-vector-indexer-at-query-time" title="Permalink to this headline">¬∂</a></h2>
<p>Jina lets you decide which kind of vector index to use when exposing the system to be queried. Almost all of Jina‚Äôs advanced vector indexers inherit from <code class="docutils literal notranslate"><span class="pre">BaseNumpyIndexer</span></code>. These classes only override methods related to querying the index, but not the ones related to storing vectors, meaning they all store vectors in the same format. Jina takes advantage of this, and has the flexibility to offer the same vector data in different vector indexer types. To implement this functionality there are two things to consider, one for indexing and one for querying.</p>
<div class="section" id="indexing">
<h3>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¬∂</a></h3>
<p>At index time, we use <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code>. It is important that the <code class="docutils literal notranslate"><span class="pre">Pod</span></code> containing this Executor ensures <code class="docutils literal notranslate"><span class="pre">read_only:</span> <span class="pre">False</span></code>. This way, the same indexer can be reconstructed from binary form, which contains information of the vectors (dimensions, ‚Ä¶) that are needed to have it work at query time.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!NumpyIndexer</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">index_filename</span><span class="p">:</span> <span class="s">&#39;vec.gz&#39;</span>
<span class="nt">metas</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">wrapidx</span>
</pre></div>
</div>
</div>
<div class="section" id="querying">
<h3>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¬∂</a></h3>
<p>At query time, we use <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code> as <code class="docutils literal notranslate"><span class="pre">ref_indexer</span></code> for any advanced indexer inheriting from <code class="docutils literal notranslate"><span class="pre">BaseNumpyIndexer</span></code> (see <code class="docutils literal notranslate"><span class="pre">AnnoyIndexer</span></code>, <code class="docutils literal notranslate"><span class="pre">FaissIndexer</span></code>, ‚Ä¶).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!FaissIndexer</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">ref_indexer</span><span class="p">:</span>
    <span class="kt">!NumpyIndexer</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">wrapidx</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="s">&#39;vec.gz&#39;</span>
</pre></div>
</div>
<p>In this case, this construction lets the <code class="docutils literal notranslate"><span class="pre">FaissIndexer</span></code> use the <code class="docutils literal notranslate"><span class="pre">vectors</span></code> stored by the indexer named <code class="docutils literal notranslate"><span class="pre">wrapidx</span></code>.</p>
</div>
</div>
<div class="section" id="override-parameters-using-queryset">
<h2>Override parameters using QuerySet<a class="headerlink" href="#override-parameters-using-queryset" title="Permalink to this headline">¬∂</a></h2>
<p>We can override parameter values in flows with the help of <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code>. <code class="docutils literal notranslate"><span class="pre">querySet</span></code> is a set of <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> protobuf messages that can be sent along with any <code class="docutils literal notranslate"><span class="pre">Request</span></code>. It is useful to dynamically override parameters of a driver for a specific request. (Not every parameter is able to be overriden)</p>
<p>This <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> has 3 main fields:</p>
<ul class="simple">
<li><p>name: A name of the driver that will be overriden (the exact class name). For now any driver in the Flow of this class will be affected by this <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code></p></li>
<li><p>parameters: A key-value map where the key is the parameter to be overriden and the value the value that it will be used in the request</p></li>
<li><p>priority: The priority this <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> has with respect to potential defaults of the driver.</p></li>
</ul>
<p>For a driver to be able to override its parameters and read from the <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> messages it needs to do 2 things:</p>
<ul class="simple">
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">QuerySetReader</span></code> as a <code class="docutils literal notranslate"><span class="pre">mix-in</span></code> class</p></li>
<li><p>Declare the attribute with an underscore prefix, i.e (<code class="docutils literal notranslate"><span class="pre">self._top_k</span></code> to have <code class="docutils literal notranslate"><span class="pre">top_k</span></code> as an attribute with the potential to be overriden)</p></li>
</ul>
<p>Suppose we want to override <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver's</span></code> top_k value of 10 with 20 in the below pod. We can see that <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code> fullfills the requirements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VectorSearchDriver</span><span class="p">(</span><span class="n">QuerySetReader</span><span class="p">,</span> <span class="n">BaseSearchDriver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">fill_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The pod is defined as taking 10 for its <code class="docutils literal notranslate"><span class="pre">top_k</span></code> parameter in the <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!CompoundIndexer</span>
<span class="nt">components</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="kt">!NumpyIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vec.gz</span>
      <span class="nt">metric</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cosine</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecidx</span>
      <span class="nt">workspace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$JINA_DIR</span>
  <span class="p p-Indicator">-</span> <span class="kt">!BinaryPbIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">doc.gz</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docidx</span>
      <span class="nt">workspace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$JINA_DIR</span>
<span class="nt">metas</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chunk_indexer</span>
  <span class="nt">workspace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$JINA_DIR</span>
<span class="nt">requests</span><span class="p">:</span>
  <span class="nt">on</span><span class="p">:</span>
    <span class="nt">IndexRequest</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="kt">!VectorIndexDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecidx</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;r&#39;</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span> <span class="kt">!KVIndexDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docidx</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;r&#39;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">[</span><span class="nv">SearchRequest</span><span class="p p-Indicator">]:</span>
      <span class="p p-Indicator">-</span> <span class="kt">!VectorSearchDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecidx</span>
          <span class="nt">top_k</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;r&#39;</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span> <span class="kt">!KVSearchDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docidx</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;m&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>We construct a queryset <code class="docutils literal notranslate"><span class="pre">top_k_queryset</span></code> which defines to use a top_k value of 20 for <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">top_k_queryset</span> <span class="o">=</span> <span class="n">jina_pb2</span><span class="o">.</span><span class="n">QueryLang</span><span class="p">()</span>
    <span class="n">top_k_queryset</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;VectorSearchDriver&#39;</span>
    <span class="n">top_k_queryset</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">top_k_queryset</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
<p>Passing <code class="docutils literal notranslate"><span class="pre">top_k_queryset</span></code> to <code class="docutils literal notranslate"><span class="pre">flow.search</span></code> will override <code class="docutils literal notranslate"><span class="pre">top_k</span></code> value of <code class="docutils literal notranslate"><span class="pre">10</span></code> with <code class="docutils literal notranslate"><span class="pre">20</span></code> in the <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code>.
Note that more than one <code class="docutils literal notranslate"><span class="pre">queryset</span></code> can be passed with any request.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">Flow</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s1">&#39;flow.yml&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">search_flow</span><span class="p">:</span>
        <span class="n">search_flow</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span> <span class="n">output_fn</span><span class="o">=</span><span class="n">print_results</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="p">[</span><span class="n">top_k_queryset</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="the-score-field">
<h2>The Score Field<a class="headerlink" href="#the-score-field" title="Permalink to this headline">¬∂</a></h2>
<p>In ranking document matches, Jina uses several algorithms to compute the <em>relevance</em> of a document given a specific query. This is stored as a numeric value in the <code class="docutils literal notranslate"><span class="pre">score</span></code> field of a <code class="docutils literal notranslate"><span class="pre">match</span></code>, both at a <code class="docutils literal notranslate"><span class="pre">document</span></code> level and at the <code class="docutils literal notranslate"><span class="pre">chunk</span></code> level. This field can mean either ‚Äúsmaller is better‚Äù (<em>distance</em>) or ‚Äúlarger is better‚Äù (<em>similarity</em>, <em>relevance</em>).</p>
<p>As, an example, the <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code> uses k-NN (with various distance metrics) to calculate a <em>distance</em>, thus ‚Äúsmaller is better‚Äù. On the other hand, the <code class="docutils literal notranslate"><span class="pre">MinRanker</span></code> uses the function <em>1/(1+s)</em> (where <em>s</em> is the min. score from all <code class="docutils literal notranslate"><span class="pre">chunks</span></code>) in order to ‚Äúbubble up‚Äù the score from child <code class="docutils literal notranslate"><span class="pre">chunks</span></code> to the parent, thus ‚Äúlarger is better‚Äù. There can be other metrics too.</p>
<p>This can pe problematic when deciding how to sort the results from a query. Fortunately, Jina provides the name of the operator that has performed the scoring:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/**
 * Represents the relevance model to `ref_id`
 */
message NamedScore {
    float value = 1; // value
    string op_name = 2; // the name of the operator/score function
    ...
}
</pre></div>
</div>
<p>Notice the field <code class="docutils literal notranslate"><span class="pre">op_name</span></code> in the above. As the comment suggests, this is the name of the operator that has performed the sorting (e.g. <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code>, or <code class="docutils literal notranslate"><span class="pre">MinRanker</span></code>). Based on this, the <code class="docutils literal notranslate"><span class="pre">value</span></code> field is either of type ‚Äúsmaller is better‚Äù or of type ‚Äúlarger is better‚Äù.</p>
<p><strong>Conclusion</strong>: When sorting results, make sure you check the <code class="docutils literal notranslate"><span class="pre">document.score.op_name</span></code> in order to understand the direction of the score.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../traversal/index.html" class="btn btn-neutral float-right" title="Understand Jina Recursive Document Representation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../101/index.html" class="btn btn-neutral float-left" title="Jina 101: First Thing to Learn About Jina" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Jina AI Limited. All rights reserved.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });

      function showhide_navbar() {
      var x = document.getElementsByClassName("wy-nav-side")[0];
      var y = document.getElementsByClassName("wy-nav-content-wrap")[0];
      var z = document.getElementById("showhide-navbar-btn");
      if (x.style.display === "none") {
        x.style.display = "block";
        y.style.marginLeft = "23rem";
        z.style.left = "23rem";
      } else {
        x.style.display = "none";
        y.style.marginLeft = "0";
        z.style.left = "0px";
      }

    }
    function showhide_littlenavbar() {
      var x = document.getElementById("little-navbar");
      if (x.style.display === "none") {
        x.style.display = "block";
      } else {
        x.style.display = "none";
      }
    }
  </script>

  <!-- Search box becomes active when you press the slash(/) key anywhere on the page-->
  <script>
    const body = document.querySelector('body');
    const searchBox = document.querySelector('form').querySelector('input[type="text"]');

    body.addEventListener('keyup', event => {
      event.preventDefault()
      if (event.key === '/') {
        searchBox.focus();
      }
    });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-164627626-3', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>